name: Test Comment Inputs

on:
  pull_request:
    types:
      - opened
      - synchronize
      - labeled

jobs:
  # Exercises reading the comment body from markdown files and updating via a second file.
  test_input_markdown_file:
    name: Test Input Markdown File
    runs-on: cp-ubuntu-amd64-1core-1gb
    permissions:
      contents: read
      pull-requests: write
    continue-on-error: true
    if: contains(github.event.pull_request.labels.*.name, 'test-inputs')
    steps:
      - name: Checkout Repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - name: Load environment variables from .env file
        run: |
          grep '^CHECK_NAME_1=' ci/vars/test.env >> $GITHUB_ENV
          grep '^COMMENT_BODY_PATH_1=' ci/vars/test.env >> $GITHUB_ENV
          grep '^COMMENT_BODY_PATH_2=' ci/vars/test.env >> $GITHUB_ENV
          grep '^CONCLUSION=' ci/vars/test.env >> $GITHUB_ENV
          grep '^UPDATE_MODE_1=' ci/vars/test.env >> $GITHUB_ENV
          grep '^UPDATE_MODE_2=' ci/vars/test.env >> $GITHUB_ENV

      - name: Comment on PR with markdown file comment
        uses: ./
        id: comment-file
        with:
          comment-id: ${{ env.CHECK_NAME_1 }}
          comment-body-path: ${{ env.COMMENT_BODY_PATH_1 }}
          conclusion: ${{ env.CONCLUSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          update-mode: ${{ env.UPDATE_MODE_1 }}

      - name: Update comment on PR with markdown file comment
        uses: ./
        id: comment-file-update
        with:
          comment-id: ${{ env.CHECK_NAME_1 }}
          comment-body-path: ${{ env.COMMENT_BODY_PATH_2 }}
          conclusion: ${{ env.CONCLUSION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          update-mode: ${{ env.UPDATE_MODE_2 }}

  # Checks that the verbose-logging input enables extended logging paths.
  test_input_verbose_logging:
    name: Test Input Verbose Logging
    runs-on: cp-ubuntu-amd64-1core-1gb
    permissions:
      contents: read
      pull-requests: write
    continue-on-error: true
    if: contains(github.event.pull_request.labels.*.name, 'test-inputs')
    steps:
      - name: Checkout Repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - name: Comment on PR with verbose logging
        uses: ./
        id: comment-direct
        with:
          comment-id: "verbose-logging"
          comment-body: "test comment using verbose logging - initial comment"
          conclusion: "success"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          verbose-logging: true
          update-mode: "create"

  # Confirms markdown formatting is not rendered when render-markdown is false.
  test_render_markdown_false:
    name: Test Render Markdown False
    runs-on: cp-ubuntu-amd64-1core-1gb
    permissions:
      contents: read
      pull-requests: write
    continue-on-error: true
    if: contains(github.event.pull_request.labels.*.name, 'test-inputs')
    steps:
      - name: Checkout Repo
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 #v5.0.0

      - name: Comment on PR with unrendered markdown comment
        uses: ./
        id: comment-file
        with:
          comment-id: "test-unrendered-markdown-comment"
          comment-body: "the **bold** should not be bold\n\nthe *italic* should not be italic\n\nthe `code` should not be code"
          conclusion: "success"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          update-mode: "create"
          render-markdown: false
